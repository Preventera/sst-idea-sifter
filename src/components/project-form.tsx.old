// src/components/project-form.tsx
// Version avec API CNESST r√©elle int√©gr√©e

import React, { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { AlertCircle, Wand2, Brain, Database, TrendingUp, AlertTriangle, Sparkles, Lightbulb, Loader2 } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { supabaseClient as supabase } from "@/lib/supabaseClient";
import { toast } from "@/hooks/use-toast";
import { Criteria, Project } from "@/types/project";
import { useAIAssistant } from "@/hooks/use-ai-assistant";
import { cnesstAPIService } from "@/services/api/cnesst-api-service";
import { aiIntegrationService } from "@/services/ai/ai-integration-service";

// Types pour les insights CNESST
interface SectorInsights {
  riskLevel: 'low' | 'medium' | 'high';
  topRisks: string[];
  totalCases: number;
  trendAnalysis: string;
  recommendations: string[];
  injuryRate?: number;
  fatalityRate?: number;
  yearlyTrend?: string;
  dataSource: 'API_REAL' | 'SIMULATION' | 'FALLBACK';
}

interface ProjectFormProps {
  onProjectCreated?: (project: Project) => void;
  onCancel?: () => void;
}

export const ProjectForm: React.FC<ProjectFormProps> = ({ onProjectCreated, onCancel }) => {
  // √âtats du formulaire
  const [name, setName] = useState("");
  const [description, setDescription] = useState("");
  const [selectedSector, setSelectedSector] = useState("");
  const [loading, setLoading] = useState(false);

  // √âtats pour les insights CNESST
  const [sectorInsights, setSectorInsights] = useState<SectorInsights | null>(null);
  const [loadingInsights, setLoadingInsights] = useState(false);
  const [showEnhancedAssistant, setShowEnhancedAssistant] = useState(false);

  // √âtats pour l'auto-√©valuation
  const [autoEvaluationSuggestions, setAutoEvaluationSuggestions] = useState<Criteria | null>(null);
  const [autoEvaluationLoading, setAutoEvaluationLoading] = useState(false);
  const [confidenceLevel, setConfidenceLevel] = useState(0);

  const [criteria, setCriteria] = useState<Criteria>({
    technicalFeasibility: 5,
    businessValue: 5,
    riskReduction: 5,
    implementationCost: 5,
    timeToMarket: 5,
    userAcceptance: 5,
    regulatoryCompliance: 5,
  });

  const { generateContent, isLoading: aiLoading } = useAIAssistant();

  // Secteurs SCIAN avec les vrais codes API
  const SCIAN_SECTORS = [
    { value: "11", label: "11 - Agriculture, foresterie, p√™che et chasse" },
    { value: "21", label: "21 - Extraction mini√®re, exploitation en carri√®re, et extraction de p√©trole et de gaz" },
    { value: "23", label: "23 - Construction" },
    { value: "31-33", label: "31-33 - Fabrication" },
    { value: "48-49", label: "48-49 - Transport et entreposage" },
    { value: "62", label: "62 - Soins de sant√© et assistance sociale" },
    { value: "72", label: "72 - Services d'h√©bergement et de restauration" },
    { value: "81", label: "81 - Autres services (sauf les administrations publiques)" },
  ];

  // Chargement des insights CNESST avec API r√©elle
  useEffect(() => {
    if (selectedSector) {
      loadSectorInsightsReal();
    } else {
      setSectorInsights(null);
      setShowEnhancedAssistant(false);
    }
  }, [selectedSector]);

  // üöÄ NOUVEAU : Fonction avec API CNESST r√©elle
  const loadSectorInsightsReal = async () => {
    if (!selectedSector) return;
    
    setLoadingInsights(true);
    console.log(`üîç Chargement des donn√©es CNESST r√©elles pour le secteur ${selectedSector}`);
    
    try {
      // üöÄ √âTAPE 1 : Tentative d'acc√®s √† l'API r√©elle
      console.log('üì° Connexion √† l\'API Donn√©es Qu√©bec...');
      const stats = await cnesstAPIService.getSectorStatistics(selectedSector);
      
      console.log('‚úÖ Donn√©es API re√ßues:', stats);
      
      // üßÆ √âTAPE 2 : Analyse des donn√©es r√©elles
      const totalCases = stats.totalCases || 0;
      const riskLevel = calculateRealRiskLevel(stats);
      const recommendations = generateContextualRecommendations(stats, selectedSector);
      
      // üìä √âTAPE 3 : Structure des insights enrichis
      const realInsights: SectorInsights = {
        riskLevel,
        topRisks: stats.topRisks?.slice(0, 3) || ['Donn√©es en cours d\'analyse'],
        totalCases,
        trendAnalysis: stats.yearlyTrend || 'Analyse bas√©e sur donn√©es 2018-2023',
        recommendations,
        injuryRate: stats.injuryRate,
        fatalityRate: stats.fatalityRate,
        yearlyTrend: stats.yearlyTrend,
        dataSource: 'API_REAL'
      };
      
      setSectorInsights(realInsights);
      setShowEnhancedAssistant(true);
      
      // üéâ Notification de succ√®s avec donn√©es r√©elles
      toast({
        title: "üìä Donn√©es CNESST r√©elles charg√©es",
        description: `${totalCases.toLocaleString()} cas analys√©s depuis l'API Donn√©es Qu√©bec`,
      });
      
      console.log('üéØ Insights g√©n√©r√©s avec succ√®s:', realInsights);
      
    } catch (error) {
      console.error('‚ùå Erreur API CNESST:', error);
      
      // üîÑ FALLBACK : Donn√©es simul√©es en cas d'erreur
      console.log('üîÑ Activation du fallback vers donn√©es simul√©es');
      const fallbackData = generateMockSectorData(selectedSector);
      setSectorInsights({
        ...fallbackData,
        dataSource: 'FALLBACK'
      });
      setShowEnhancedAssistant(true);
      
      toast({
        title: "‚ö†Ô∏è Fallback activ√©",
        description: "API CNESST temporairement indisponible - Donn√©es de d√©monstration utilis√©es",
        variant: "destructive",
      });
      
    } finally {
      setLoadingInsights(false);
    }
  };

  // üßÆ NOUVEAU : Calcul de risque bas√© sur vraies donn√©es
  const calculateRealRiskLevel = (stats: any): 'low' | 'medium' | 'high' => {
    const { totalCases, injuryRate, fatalityRate, trendDirection } = stats;
    
    // Algorithme multi-facteurs bas√© sur donn√©es r√©elles
    let riskScore = 0;
    
    // Facteur 1: Volume de cas (40% du score)
    if (totalCases > 15000) riskScore += 40;
    else if (totalCases > 8000) riskScore += 30;
    else if (totalCases > 3000) riskScore += 20;
    else if (totalCases > 1000) riskScore += 10;
    
    // Facteur 2: Taux de blessures (30% du score)
    if (injuryRate > 15) riskScore += 30;
    else if (injuryRate > 8) riskScore += 20;
    else if (injuryRate > 3) riskScore += 10;
    
    // Facteur 3: Taux de mortalit√© (20% du score)
    if (fatalityRate > 0.5) riskScore += 20;
    else if (fatalityRate > 0.1) riskScore += 15;
    else if (fatalityRate > 0.05) riskScore += 10;
    
    // Facteur 4: Tendance (10% du score)
    if (trendDirection === 'increasing') riskScore += 10;
    else if (trendDirection === 'stable') riskScore += 5;
    
    // Classification finale bas√©e sur score composite
    if (riskScore >= 70) return 'high';
    if (riskScore >= 35) return 'medium';
    return 'low';
  };

  // üìã NOUVEAU : Recommandations bas√©es sur vraies donn√©es
  const generateContextualRecommendations = (stats: any, sector: string): string[] => {
    const recommendations = [];
    const { totalCases, topRisks, trendDirection, seasonalPatterns, injuryRate } = stats;
    
    // Recommandations bas√©es sur le volume de cas
    if (totalCases > 15000) {
      recommendations.push('üî¥ Secteur critique - Intervention IA urgente recommand√©e');
      recommendations.push('üìä Syst√®me de surveillance continue obligatoire');
    } else if (totalCases > 8000) {
      recommendations.push('üü° Secteur √† haut risque - Solutions IA pr√©ventives prioritaires');
      recommendations.push('üìà Monitoring renforc√© des indicateurs cl√©s');
    } else if (totalCases > 3000) {
      recommendations.push('üü† Secteur mod√©r√© - Optimisation par IA conseill√©e');
    } else {
      recommendations.push('üü¢ Secteur stable - Maintien des bonnes pratiques');
    }
    
    // Recommandations sp√©cifiques aux risques dominants
    if (topRisks) {
      if (topRisks.some((risk: string) => risk.toLowerCase().includes('chute'))) {
        recommendations.push('üéØ Priorit√© absolue: D√©tection IA des situations de chute');
      }
      if (topRisks.some((risk: string) => risk.toLowerCase().includes('machine'))) {
        recommendations.push('ü§ñ Surveillance pr√©dictive des √©quipements critiques');
      }
      if (topRisks.some((risk: string) => risk.toLowerCase().includes('chimique'))) {
        recommendations.push('‚öóÔ∏è Monitoring temps r√©el de l\'exposition aux substances');
      }
      if (topRisks.some((risk: string) => risk.toLowerCase().includes('transport'))) {
        recommendations.push('üöõ Syst√®me de tracking et alerte pour v√©hicules');
      }
    }
    
    // Recommandations bas√©es sur les tendances temporelles
    if (trendDirection === 'increasing') {
      recommendations.push('üìà Alerte: Tendance √† la hausse - Action pr√©ventive imm√©diate');
    } else if (trendDirection === 'decreasing') {
      recommendations.push('üìâ Progr√®s constat√© - Consolidation des mesures actuelles');
    }
    
    // Recommandations saisonni√®res (si donn√©es disponibles)
    if (seasonalPatterns?.peak) {
      recommendations.push(`üìÖ Pic saisonnier identifi√©: ${seasonalPatterns.peak} - Pr√©paration anticip√©e`);
    }
    
    // Recommandations sectorielles sp√©cifiques
    const sectorSpecific = getSectorSpecificRecommendations(sector, injuryRate);
    recommendations.push(...sectorSpecific);
    
    // Conformit√© r√©glementaire
    recommendations.push('üìã Assurer conformit√© ISO 45001 et r√©glementations CNESST');
    
    return recommendations.slice(0, 6); // Limiter √† 6 recommandations max
  };

  // üè≠ Recommandations sp√©cifiques par secteur
  const getSectorSpecificRecommendations = (sector: string, injuryRate?: number): string[] => {
    const sectorRecs: Record<string, string[]> = {
      '23': [ // Construction
        'üèóÔ∏è IA pour d√©tection d\'√©quipements de protection individuelle',
        'üìè Monitoring des zones de hauteur et √©chafaudages'
      ],
      '31-33': [ // Fabrication
        '‚öôÔ∏è Maintenance pr√©dictive par apprentissage automatique',
        'üîß D√©tection d\'anomalies en temps r√©el sur cha√Ænes'
      ],
      '48-49': [ // Transport
        'üöõ Syst√®me d\'assistance √† la conduite avanc√©',
        'üì± Monitoring de la fatigue des conducteurs'
      ],
      '62': [ // Soins de sant√©
        'üè• Ergonomie assist√©e par IA pour manipulations',
        'ü¶† Surveillance exposition risques biologiques'
      ],
      '21': [ // Extraction mini√®re
        '‚õèÔ∏è Surveillance g√©ologique pr√©dictive',
        'üí® Monitoring continu de la qualit√© de l\'air'
      ]
    };
    
    return sectorRecs[sector] || ['üîß Solutions IA adapt√©es au secteur d\'activit√©'];
  };

  // üîÑ CONSERV√â : Fonction de fallback (donn√©es simul√©es)
  const generateMockSectorData = (sector: string): SectorInsights => {
    const sectorData: Record<string, SectorInsights> = {
      "23": {
        riskLevel: 'high',
        topRisks: ['Chutes de hauteur', '√âquipements lourds', 'Mat√©riaux dangereux'],
        totalCases: 25000,
        trendAnalysis: 'Tendance √† la hausse (donn√©es simul√©es)',
        recommendations: [
          'üî¥ Secteur √† haut risque - Solutions IA prioritaires',
          'üéØ Focus sur la d√©tection de chutes',
          'üìã Int√©grer les normes ISO 45001'
        ],
        dataSource: 'SIMULATION'
      },
      "31-33": {
        riskLevel: 'medium',
        topRisks: ['Machines industrielles', 'Substances chimiques', 'Bruit'],
        totalCases: 12000,
        trendAnalysis: 'Tendance stable (donn√©es simul√©es)',
        recommendations: [
          'üü° Risque mod√©r√© - Optimisation recommand√©e',
          'ü§ñ Surveillance des √©quipements par IA',
          'üîß Maintenance pr√©dictive'
        ],
        dataSource: 'SIMULATION'
      },
      "62": {
        riskLevel: 'medium',
        topRisks: ['Troubles musculo-squelettiques', 'Exposition biologique', 'Stress'],
        totalCases: 8000,
        trendAnalysis: 'Tendance l√©g√®rement d√©croissante (donn√©es simul√©es)',
        recommendations: [
          'üè• Secteur sensible - Pr√©vention cibl√©e',
          'üí° IA pour l\'ergonomie',
          'üõ°Ô∏è Protection du personnel soignant'
        ],
        dataSource: 'SIMULATION'
      }
    };

    return sectorData[sector] || {
      riskLevel: 'low',
      topRisks: ['Risques g√©n√©riques'],
      totalCases: 1000,
      trendAnalysis: 'Donn√©es limit√©es (simulation)',
      recommendations: ['üü¢ Risque faible - Maintien des bonnes pratiques'],
      dataSource: 'SIMULATION'
    };
  };

  const getRiskLevelColor = (level: string) => {
    switch (level) {
      case 'high': return 'bg-red-100 text-red-800 border-red-200';
      case 'medium': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'low': return 'bg-green-100 text-green-800 border-green-200';
      default: return 'bg-gray-100 text-gray-800 border-gray-200';
    }
  };

  const getRiskIcon = (level: string) => {
    switch (level) {
      case 'high': return <AlertTriangle className="h-3 w-3" />;
      case 'medium': return <TrendingUp className="h-3 w-3" />;
      case 'low': return <Sparkles className="h-3 w-3" />;
      default: return <Database className="h-3 w-3" />;
    }
  };

  // üéØ Badge pour indiquer la source des donn√©es
  const getDataSourceBadge = (dataSource: string) => {
    switch (dataSource) {
      case 'API_REAL':
        return (
          <Badge variant="outline" className="text-xs bg-green-50 text-green-700 border-green-200">
            üì° API R√©elle
          </Badge>
        );
      case 'SIMULATION':
        return (
          <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200">
            üé≠ Simulation
          </Badge>
        );
      case 'FALLBACK':
        return (
          <Badge variant="outline" className="text-xs bg-orange-50 text-orange-700 border-orange-200">
            üîÑ Fallback
          </Badge>
        );
      default:
        return null;
    }
  };

  const generateEnhancedIdeas = async () => {
    if (!name.trim()) {
      toast({
        title: "Champ requis",
        description: "Veuillez saisir un nom pour le projet",
        variant: "destructive",
      });
      return;
    }

    try {
      // G√©n√©ration avec contexte CNESST enrichi si disponible
      let prompt = "";
      
      if (sectorInsights && selectedSector) {
        prompt = `En tant qu'expert en IA et SST, g√©n√©rez 3 id√©es de projets d'intelligence artificielle pour "${name}".

CONTEXTE SECTORIEL CNESST (${sectorInsights.dataSource === 'API_REAL' ? 'DONN√âES R√âELLES' : 'DONN√âES SIMUL√âES'}):
- Secteur: ${selectedSector}
- Niveau de risque: ${sectorInsights.riskLevel}
- Cas analys√©s: ${sectorInsights.totalCases.toLocaleString()}
- Risques principaux: ${sectorInsights.topRisks.join(', ')}
- Tendance: ${sectorInsights.trendAnalysis}

Pour chaque id√©e, fournissez:
1. Un titre accrocheur
2. Une description technique claire
3. L'impact SST attendu sp√©cifique au secteur
4. Les technologies recommand√©es
5. Les crit√®res de succ√®s mesurables

Int√©grez les recommandations sectorielles: ${sectorInsights.recommendations.join(', ')}`;
      } else {
        prompt = `En tant qu'expert en IA et SST, g√©n√©rez 3 id√©es de projets d'intelligence artificielle bas√©es sur: "${name}".

Pour chaque id√©e, fournissez:
1. Un titre accrocheur
2. Une description technique claire
3. L'impact SST attendu
4. Les technologies recommand√©es
5. Les crit√®res de succ√®s`;
      }

      const response = await generateContent(prompt, 'claude');
      
      if (response) {
        setDescription(response);
        toast({
          title: "‚ú® Id√©es g√©n√©r√©es avec succ√®s",
          description: sectorInsights ? 
            `G√©n√©ration enrichie avec ${sectorInsights.totalCases.toLocaleString()} cas CNESST ${sectorInsights.dataSource === 'API_REAL' ? '(donn√©es r√©elles)' : '(simulation)'}` : 
            "G√©n√©ration standard effectu√©e",
        });
      }
      
    } catch (error) {
      console.error('Erreur g√©n√©ration:', error);
      toast({
        title: "Erreur",
        description: "Impossible de g√©n√©rer les id√©es. Veuillez r√©essayer.",
        variant: "destructive",
      });
    }
  };

  const handleAutoEvaluation = async () => {
    if (!name.trim() && !description.trim()) {
      toast({
        title: "Contenu insuffisant",
        description: "Veuillez saisir au moins un nom ou une description pour l'auto-√©valuation",
        variant: "destructive",
      });
      return;
    }

    setAutoEvaluationLoading(true);
    try {
      const content = `${name}\n\n${description}`.trim();
      const contextInfo = selectedSector ? `Secteur: ${selectedSector}` : '';
      
      const prompt = `En tant qu'expert en √©valuation de projets IA-SST, √©valuez ce projet selon ces 7 crit√®res (score de 1 √† 10):

${contextInfo ? `${contextInfo}\n` : ''}
Projet √† √©valuer: ${content}

Fournissez UNIQUEMENT les scores num√©riques dans ce format exact:
Faisabilit√© technique: X/10
Valeur d'affaires: X/10  
R√©duction des risques: X/10
Co√ªt d'impl√©mentation: X/10
Temps de mise en march√©: X/10
Acceptation utilisateur: X/10
Conformit√© r√©glementaire: X/10

Niveau de confiance global: X/10`;

      const response = await generateContent(prompt, 'claude');
      
      if (response) {
        const scores = extractScoresFromResponse(response);
        if (scores) {
          setAutoEvaluationSuggestions(scores);
          setConfidenceLevel(extractConfidenceFromResponse(response));
          toast({
            title: "‚úÖ Auto-√©valuation termin√©e",
            description: "Les scores sugg√©r√©s sont maintenant disponibles",
          });
        } else {
          throw new Error("Format de r√©ponse invalide");
        }
      }
    } catch (error) {
      console.error('Erreur auto-√©valuation:', error);
      toast({
        title: "Erreur d'√©valuation",
        description: "Impossible d'√©valuer automatiquement. Veuillez essayer manuellement.",
        variant: "destructive",
      });
    } finally {
      setAutoEvaluationLoading(false);
    }
  };

  const extractScoresFromResponse = (response: string): Criteria | null => {
    try {
      const lines = response.split('\n');
      const scores: Partial<Criteria> = {};
      
      for (const line of lines) {
        if (line.includes('Faisabilit√© technique:')) {
          scores.technicalFeasibility = extractScore(line);
        } else if (line.includes('Valeur d\'affaires:')) {
          scores.businessValue = extractScore(line);
        } else if (line.includes('R√©duction des risques:')) {
          scores.riskReduction = extractScore(line);
        } else if (line.includes('Co√ªt d\'impl√©mentation:')) {
          scores.implementationCost = extractScore(line);
        } else if (line.includes('Temps de mise en march√©:')) {
          scores.timeToMarket = extractScore(line);
        } else if (line.includes('Acceptation utilisateur:')) {
          scores.userAcceptance = extractScore(line);
        } else if (line.includes('Conformit√© r√©glementaire:')) {
          scores.regulatoryCompliance = extractScore(line);
        }
      }
      
      return Object.keys(scores).length === 7 ? scores as Criteria : null;
    } catch {
      return null;
    }
  };

  const extractScore = (line: string): number => {
    const match = line.match(/(\d+)\/10/);
    return match ? Math.min(10, Math.max(1, parseInt(match[1]))) : 5;
  };

  const extractConfidenceFromResponse = (response: string): number => {
    const confidenceMatch = response.match(/Niveau de confiance global:\s*(\d+)\/10/);
    return confidenceMatch ? parseInt(confidenceMatch[1]) : 7;
  };

  const applySuggestedScores = () => {
    if (autoEvaluationSuggestions) {
      setCriteria(autoEvaluationSuggestions);
      setAutoEvaluationSuggestions(null);
      toast({
        title: "Scores appliqu√©s",
        description: "Les scores sugg√©r√©s ont √©t√© appliqu√©s aux crit√®res",
      });
    }
  };

  const ignoreAutoScoring = () => {
    setAutoEvaluationSuggestions(null);
    toast({
      title: "Suggestions ignor√©es",
      description: "Vous pouvez ajuster les crit√®res manuellement",
    });
  };

  const calculateTotalScore = () => {
    const weights = {
      technicalFeasibility: 0.2,
      businessValue: 0.2,
      riskReduction: 0.15,
      implementationCost: 0.15,
      timeToMarket: 0.1,
      userAcceptance: 0.1,
      regulatoryCompliance: 0.1,
    };

    return Object.entries(criteria).reduce((total, [key, value]) => {
      return total + (value * weights[key as keyof Criteria]);
    }, 0);
  };

  const handleSubmit = async () => {
    if (!name.trim()) {
      toast({
        title: "Nom requis",
        description: "Veuillez saisir un nom pour le projet",
        variant: "destructive",
      });
      return;
    }

    if (!selectedSector) {
      toast({
        title: "Secteur requis", 
        description: "Veuillez s√©lectionner un secteur d'activit√©",
        variant: "destructive",
      });
      return;
    }

    setLoading(true);
    try {
      const totalScore = calculateTotalScore();
      
      const { data, error } = await supabase
        .from('projects')
        .insert([
          {
            name: name.trim(),
            description: description.trim(),
            sector: selectedSector,
            criteria,
            total_score: totalScore,
          }
        ])
        .select()
        .single();

      if (error) throw error;

      toast({
        title: "Projet cr√©√© avec succ√®s",
        description: `Score total: ${totalScore.toFixed(2)}/10`,
      });

      if (onProjectCreated && data) {
        onProjectCreated(data);
      } else {
        window.location.href = '/';
      }

    } catch (error) {
      console.error('Erreur cr√©ation projet:', error);
      toast({
        title: "Erreur",
        description: "Impossible de cr√©er le projet. Veuillez r√©essayer.",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="w-full max-w-5xl mx-auto p-6 space-y-6">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Brain className="h-5 w-5" />
            Nouveau projet IA-SST
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          
          {/* Section Nom du projet avec insights CNESST */}
          <div className="space-y-4">
            <div>
              <label htmlFor="project-name" className="block text-sm font-medium text-gray-700 mb-2">
                Nom du projet *
              </label>
              <Input
                id="project-name"
                placeholder="Ex: Syst√®me de d√©tection IA pour √©quipements de protection"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full"
              />
            </div>

            {/* üöÄ Insights CNESST avec API r√©elle */}
            {selectedSector && sectorInsights && (
              <Card className="bg-blue-50 border-blue-200">
                <CardContent className="p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Database className="h-4 w-4 text-blue-600" />
                    <h4 className="text-sm font-medium text-blue-900">
                      Insights CNESST - Secteur {selectedSector}
                    </h4>
                    {getDataSourceBadge(sectorInsights.dataSource)}
                    {loadingInsights && <Loader2 className="h-3 w-3 animate-spin" />}
                  </div>
                  
                  {!loadingInsights && (
                    <div className="space-y-3">
                      <div className="flex items-center gap-2">
                        <Badge 
                          variant="outline" 
                          className={`text-xs ${getRiskLevelColor(sectorInsights.riskLevel)}`}
                        >
                          {getRiskIcon(sectorInsights.riskLevel)}
                          <span className="ml-1">
                            Risque {sectorInsights.riskLevel === 'high' ? '√©lev√©' : 
                                    sectorInsights.riskLevel === 'medium' ? 'moyen' : 'faible'}
                          </span>
                        </Badge>
                        <span className="text-xs text-blue-700">
                          {sectorInsights.totalCases.toLocaleString()} cas analys√©s
                        </span>
                      </div>
                      
                      {sectorInsights.topRisks.length > 0 && (
                        <div className="text-xs text-blue-800">
                          <span className="font-medium">Risques principaux:</span>{' '}
                          {sectorInsights.topRisks.join(', ')}
                        </div>
                      )}
                      
                      <div className="text-xs text-blue-800">
                        <span className="font-medium">Tendance:</span>{' '}
                        {sectorInsights.trendAnalysis}
                      </div>
                      
                      {sectorInsights.recommendations.length > 0 && (
                        <div className="text-xs text-blue-800">
                          <div className="font-medium mb-1">Recommandations:</div>
                          <ul className="space-y-1">
                            {sectorInsights.recommendations.map((rec, idx) => (
                              <li key={idx} className="flex items-start gap-1">
                                <span className="text-blue-600">‚Ä¢</span>
                                <span>{rec}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* Assistant IA enrichi */}
            {name.trim() && (
              <div className="space-y-3">
                <div className="flex items-center gap-2">
                  <Lightbulb className="h-4 w-4 text-purple-600" />
                  <span className="text-sm font-medium text-gray-700">Assistant IA</span>
                  {showEnhancedAssistant && (
                    <Badge variant="outline" className="text-xs bg-green-50 text-green-700 border-green-200">
                      ‚ú® Mode enrichi CNESST
                    </Badge>
                  )}
                  {sectorInsights?.dataSource === 'API_REAL' && (
                    <Badge variant="outline" className="text-xs bg-emerald-50 text-emerald-700 border-emerald-200">
                      üöÄ Donn√©es r√©elles
                    </Badge>
                  )}
                </div>
                <Button
                  type="button"
                  variant="outline"
                  onClick={generateEnhancedIdeas}
                  disabled={aiLoading}
                  className="w-full"
                >
                  {aiLoading ? (
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  ) : (
                    <Wand2 className="h-4 w-4 mr-2" />
                  )}
                  {showEnhancedAssistant 
                    ? "G√©n√©rer des id√©es contextualis√©es" 
                    : "G√©n√©rer des id√©es avec l'IA"
                  }
                </Button>
                {showEnhancedAssistant && sectorInsights && (
                  <p className="text-xs text-gray-600">
                    G√©n√©ration enrichie avec {sectorInsights.totalCases.toLocaleString()} cas CNESST du secteur {selectedSector}
                    {sectorInsights.dataSource === 'API_REAL' && (
                      <span className="text-green-600 font-medium"> (donn√©es r√©elles API)</span>
                    )}
                  </p>
                )}
              </div>
            )}
          </div>

          {/* Secteur d'activit√© */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Secteur d'activit√© *
            </label>
            <select
              value={selectedSector}
              onChange={(e) => setSelectedSector(e.target.value)}
              className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">S√©lectionnez un secteur SCIAN</option>
              {SCIAN_SECTORS.map((sector) => (
                <option key={sector.value} value={sector.value}>
                  {sector.label}
                </option>
              ))}
            </select>
          </div>

          {/* Description du projet */}
          <div>
            <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-2">
              Description du projet
            </label>
            <Textarea
              id="description"
              placeholder="D√©crivez votre projet d'intelligence artificielle en d√©tail..."
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              rows={6}
              className="w-full"
            />
          </div>

          {/* Auto-√©valuation IA */}
          <Card className="bg-gray-50">
            <CardContent className="p-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <Brain className="h-4 w-4 text-blue-600" />
                  <span className="text-sm font-medium">Auto-√©valuation IA des crit√®res</span>
                  {confidenceLevel > 0 && (
                    <Badge variant="outline" className="text-xs">
                      Confiance: {confidenceLevel}/10
                    </Badge>
                  )}
                </div>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={handleAutoEvaluation}
                  disabled={autoEvaluationLoading}
                >
                  {autoEvaluationLoading ? (
                    <Loader2 className="h-4 w-4 mr-1 animate-spin" />
                  ) : (
                    <Wand2 className="h-4 w-4 mr-1" />
                  )}
                  √âvaluer automatiquement
                </Button>
              </div>

              {autoEvaluationSuggestions && (
                <Alert className="mb-4">
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription className="flex items-center justify-between">
                    <span>L'IA sugg√®re des scores bas√©s sur l'analyse du projet</span>
                    <div className="flex gap-2">
                      <Button size="sm" onClick={applySuggestedScores}>
                        Appliquer
                      </Button>
                      <Button size="sm" variant="outline" onClick={ignoreAutoScoring}>
                        Ignorer
                      </Button>
                    </div>
                  </AlertDescription>
                </Alert>
              )}
            </CardContent>
          </Card>

          {/* Crit√®res d'√©valuation */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Crit√®res d'√©valuation</h3>
            <div className="grid gap-4">
              {Object.entries(criteria).map(([key, value]) => {
                const labels: Record<string, string> = {
                  technicalFeasibility: "Faisabilit√© technique",
                  businessValue: "Valeur d'affaires",
                  riskReduction: "R√©duction des risques",
                  implementationCost: "Co√ªt d'impl√©mentation",
                  timeToMarket: "Temps de mise en march√©",
                  userAcceptance: "Acceptation utilisateur",
                  regulatoryCompliance: "Conformit√© r√©glementaire",
                };
                
                return (
                  <div key={key} className="space-y-2">
                    <div className="flex justify-between items-center">
                      <label className="text-sm font-medium">{labels[key]}</label>
                      <span className="text-sm text-gray-600">{value}/10</span>
                    </div>
                    <input
                      type="range"
                      min="1"
                      max="10"
                      value={value}
                      onChange={(e) => setCriteria(prev => ({ 
                        ...prev, 
                        [key]: parseInt(e.target.value) 
                      }))}
                      className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                  </div>
                );
              })}
            </div>
          </div>

          {/* Score total */}
          <Card className="bg-blue-50">
            <CardContent className="p-4">
              <div className="text-center">
                <h3 className="text-lg font-semibold text-blue-900">Score total</h3>
                <div className="text-3xl font-bold text-blue-600">
                  {calculateTotalScore().toFixed(2)}/10
                </div>
                {sectorInsights?.dataSource === 'API_REAL' && (
                  <p className="text-xs text-blue-700 mt-1">
                    √âvaluation enrichie avec donn√©es CNESST r√©elles
                  </p>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Actions */}
          <div className="flex gap-4 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={() => onCancel ? onCancel() : window.history.back()}
              className="flex-1"
            >
              Annuler
            </Button>
            <Button
              type="button"
              onClick={handleSubmit}
              disabled={loading}
              className="flex-1"
            >
              {loading ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Wand2 className="h-4 w-4 mr-2" />
              )}
              Cr√©er le projet
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};